name: Release Artifact

on:
  workflow_run:
    workflows: ["Build_oneplus_sm8750"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      run-id:
        description: '特定工作流运行的ID（可选）'
        required: false

# 关键修复：提升令牌权限
permissions:
  contents: write
  actions: read
  packages: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # 1. 确定要使用的运行ID
      - name: Resolve Workflow Run ID
        id: resolve_run_id
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.inputs.run-id }}" ]; then
            echo "run_id=${{ github.event.inputs.run-id }}" >> $GITHUB_OUTPUT
          else
            # 获取最近成功的运行
            echo "run_id=$(gh run list --workflow=Build_oneplus_sm8750.yml --json=databaseId,conclusion,status --jq='.[] | select(.status=="completed" and .conclusion=="success") | .databaseId' --limit 1)" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. 获取构建产物的信息
      - name: Get Artifact Metadata
        id: get_artifact
        run: |
          # 获取该运行的所有构建产物
          artifacts=$(gh run download ${{ steps.resolve_run_id.outputs.run_id }} --repo $GITHUB_REPOSITORY --dir /tmp/artifacts --pattern '*')
          
          # 找到实际文件（绕过 GitHub 的打包方式）
          artifact_path=$(find /tmp/artifacts -type f ! -name '*.zip' | head -1)
          artifact_name=$(basename "$artifact_path")
          release_title=$(basename "$artifact_path" | cut -f 1 -d '.')
          
          echo "artifact_path=$artifact_path" >> $GITHUB_OUTPUT
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "release_title=$release_title" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3. 创建 Release
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ steps.resolve_run_id.outputs.run_id }}
          name: ${{ steps.get_artifact.outputs.release_title }}
          draft: false
          prerelease: false

      # 4. 上传构建产物
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.get_artifact.outputs.artifact_path }}
          asset_name: ${{ steps.get_artifact.outputs.artifact_name }}
